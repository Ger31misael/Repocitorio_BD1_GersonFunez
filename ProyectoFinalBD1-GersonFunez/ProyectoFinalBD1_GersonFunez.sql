CREATE DATABASE ProyectoFinalBD1;


USE ProyectoFinalBD1;

CREATE TABLE Cliente (
    Usuario VARCHAR(40) PRIMARY KEY NOT NULL,
    Contraseña VARCHAR(30) NOT NULL,
    Nombre VARCHAR (30) NOT NULL,
    Apellido VARCHAR(30) NOT NULL,
    FechaNacimiento DATE NOT NULL,
    Departamento VARCHAR (100) NOT NULL,
    Municipio VARCHAR (50) NOT NULL,
    Ciudad VARCHAR(50) NOT NULL,
    Colonia VARCHAR(50) NOT NULL,
    Bloque VARCHAR(50) NOT NULL,
    Calle VARCHAR(50) NOT NULL,
    Casa VARCHAR (50) NOT NULL,
    Descripcion VARCHAR(150) NOT NULL,
    TFijo VARCHAR (50),
    TCelular VARCHAR (50),
    Correo VARCHAR (70) NOT NULL
)

INSERT INTO Cliente VALUES('GER81FUNEZ','123456789', 'GERSON', 'FUNEZ', '28-06-1997', 'FRANCISCO MORAZAN','MDC' ,'TEGUCIGALPA','NUEVA ESPAÑA', '10','PRINCIPAL', '11', 'CASA ESQINA OPUESTA A UNA PULPERIA', '22-22-22-22','30-30-30-30','G81@GMAIL.COM')
INSERT INTO Cliente VALUES('KER77ROBLES','123456789', 'KERLYN', 'ROBLES', '06-07-1997', 'FRANCISCO MORAZAN','MDC' ,'TEGUCIGALPA','ARTURO QUEZADA', '12','PRINCIPAL', '110', 'CASA COLOR MORADO', '22-21-25-29','33-21-30-68','KER97@GMAIL.COM')
INSERT INTO Cliente VALUES('ALE','123456789', 'ALEJANDRA', 'MARADIAGA', '17-01-1999', 'FRANCISCO MORAZAN','MDC' ,'TEGUCIGALPA','FLORENCIA', 'M-4','PRINCIPAL', '31', 'CASA CON PORTON NEGRO', '2231-1568','97-30-50-21','ALE99@GMAIL.COM')
INSERT INTO Cliente VALUES('PEDRO98','123456789', 'PEDRO', 'PICAPIEDRAS', '28-04-1990', 'FRANCISCO MORAZAN','MDC' ,'TEGUCIGALPA',' AUSTRALIA', '5','PRINCIPAL', '17', 'CASA COLOR AZUL, OPUESTA A UNA PULPERIA', '22-42-91-22','80-30-30-30','PEDRO28@GMAIL.COM')
INSERT INTO Cliente VALUES('MORDO14','123456789', 'MORDECAY', 'ZANCHES', '31-03-1992', 'FRANCISCO MORAZAN','MDC' ,'TEGUCIGALPA','LOS ROBLES', 'M-1','PRINCIPAL', '21', 'CASA ESQINA OPUESTA A TALLER DE COSTURA', '22-15-03-22','88-20-18-50','MORD01@GMAIL.COM')
SELECT * FROM Cliente

CREATE TABLE Compra (
    IdCompra INT PRIMARY KEY IDENTITY(1,1),
    IdSucursal INT FOREIGN KEY REFERENCES Sucursal(IdSucursal),
    Usuario VARCHAR (40) FOREIGN KEY REFERENCES Cliente(Usuario),
    FechaCompra DATETIME NOT NULL
)

INSERT INTO Compra VALUES (1,'GER81FUNEZ','10-03-22')
INSERT INTO Compra VALUES (1,'GER81FUNEZ','12-03-22')
INSERT INTO Compra VALUES (1,'GER81FUNEZ','13-04-22')
INSERT INTO Compra VALUES (2,'KER77ROBLES','14-03-22')
INSERT INTO Compra VALUES (3,'MORDO14','10-03-22')
INSERT INTO Compra VALUES (4,'MORDO14','11-03-22')
INSERT INTO Compra VALUES (5,'MORDO14','12-03-22')
INSERT INTO Compra VALUES (2,'MORDO14','13-03-22')
INSERT INTO Compra VALUES (2,'PEDRO98','14-03-22')
INSERT INTO Compra VALUES (3,'PEDRO98','15-03-22')
INSERT INTO Compra VALUES (3,'PEDRO98','11-03-22')
INSERT INTO Compra VALUES (1,'PEDRO98','11-03-22')
INSERT INTO Compra VALUES (1,'KER77ROBLES','18-03-22')
INSERT INTO Compra VALUES (1,'KER77ROBLES','19-03-22')
SELECT * FROM Compra


CREATE TABLE Categoria (
    IdCategoria INT PRIMARY KEY IDENTITY(1,1),
    Tipo VARCHAR (50) NOT NULL,
    Fotografia IMAGE NOT NULL
)


INSERT INTO Categoria VALUES ('MEDICAMENTO',0x1522F777777773777FE)
INSERT INTO Categoria VALUES ('CUIDADO PERSONAL',0x151C2F777777773777FE)
INSERT INTO Categoria VALUES ('ELECTRONICOS',0x155C2F777777773777FE)
INSERT INTO Categoria VALUES ('LENTES',0x181C2F777777773777FE)
INSERT INTO Categoria VALUES ('ABARROTERIA',0x981C2F777777773777FE4)
SELECT * FROM Categoria

CREATE TABLE Promocion (
    IdPromo INT PRIMARY KEY IDENTITY(1,1),
    FechaInicio DATETIME NOT NULL,
    FechaFin DATETIME NOT NULL,
    Descuento MONEY NOT NULL
)

INSERT INTO Promocion VALUES ('08-04-22','09-04-22',10)
INSERT INTO Promocion VALUES ('18-04-22','22-04-22',20)
INSERT INTO Promocion VALUES ('06-05-22','12-05-22',11)
INSERT INTO Promocion VALUES ('15-06-22','09-07-22',12)
INSERT INTO Promocion VALUES ('08-09-22','09-09-22',16)
SELECT * FROM Promocion


CREATE TABLE Producto (
    IdProducto INT PRIMARY KEY IDENTITY(1,1),
    NombreP VARCHAR (50) NOT NULL,
    PrecioCompra MONEY NOT NULL,
    PrecioVenta MONEY NOT NULL,
    Descripcion VARCHAR (150) NOT NULL,
    Provedor VARCHAR(50) NOT NULL,
    IdCategoria INT REFERENCES Categoria(IdCategoria),
    IdPromo INT REFERENCES Promocion(IdPromo),
    
)

INSERT INTO Producto VALUES('VITAMINA C',30,45,'TABLETAS','CON HARINA MEDICAL', 1,1)
INSERT INTO Producto VALUES('VITAMINA D',54,100,'FRASCO TABLETAS','LAB MEDICAL', 1,1)
INSERT INTO Producto VALUES('CREMA FACIAL',50,85,'CREMA','MEDICAL', 2,1)
INSERT INTO Producto VALUES('DENTRIFICO COLGATE',60,105,'DENTRIFICO','COLGATE', 2,1)
INSERT INTO Producto VALUES('AUDIFONOS',110,245,'AUDIFONOS BLANCOS','SONY', 3,1)
INSERT INTO Producto VALUES('CARGADOR',80,150,'CARGADOR ORININAL','HUAWEI', 3,1)
INSERT INTO Producto VALUES('LENTES DE SOL',30,45,'LENTES DE SOL NIÑA','PS LUZ', 4,1)
INSERT INTO Producto VALUES('LENTES DE SOL',30,45,'LENTES DE SOL FEMENINOS','PS LUZ', 4,4)
INSERT INTO Producto VALUES('PAN BIMBO',15,28,'PAN','BIMBO', 5,1)
INSERT INTO Producto VALUES('pepsi lata',13,17,'REFRESCO LATA','PEPSI', 5,2)
INSERT INTO Producto VALUES('COCA COLA LATA',13,17,'REFRESCO LATA','COCA COLA', 5,1)
INSERT INTO Producto VALUES('ACETAMINOFEN',30,45,'TABLETAS','CON HARINA MEDICAL', 1,1)
INSERT INTO Producto VALUES('VITAMINA C',30,45,'TABLETAS','PRO MEDICAL', 1,1)
INSERT INTO Producto VALUES('VITAMINA C',28,45,'TABLETAS','INFARMA', 1,1)
SELECT * FROM Producto



CREATE TABLE DetalleCompra (
    IdCompra INT FOREIGN KEY REFERENCES Compra(IdCompra),
    IdProducto INT FOREIGN KEY REFERENCES Producto(IdProducto),
    Descuento MONEY NOT NULL,
    Cantidad INT NOT NULL,
    PrecioVenta MONEY NOT NULL
)

INSERT INTO DetalleCompra VALUES(1,1,10,1,45)
INSERT INTO DetalleCompra VALUES(2,2,10,1,100)
INSERT INTO DetalleCompra VALUES(3,2,10,1,100)
INSERT INTO DetalleCompra VALUES(4,2,10,2,105)
INSERT INTO DetalleCompra VALUES(5,5,10,1,245)
INSERT INTO DetalleCompra VALUES(5,5,10,1,245)
INSERT INTO DetalleCompra VALUES(6,6,10,2,150)
INSERT INTO DetalleCompra VALUES(8,6,10,1,45)
INSERT INTO DetalleCompra VALUES(9,7,10,3,28)
INSERT INTO DetalleCompra VALUES(10,8,10,4,17)
INSERT INTO DetalleCompra VALUES(12,9,10,1,45)
INSERT INTO DetalleCompra VALUES(13,10,10,3,45)
INSERT INTO DetalleCompra VALUES(14,11,10,2,45)
INSERT INTO DetalleCompra VALUES(11,12,10,4,17)
SELECT * FROM DetalleCompra

CREATE TABLE Inventario (
    IdInventario INT PRIMARY KEY IDENTITY(1,1),
    IdProducto INT FOREIGN KEY REFERENCES Producto(IdProducto),
    IdSucursal INT FOREIGN KEY REFERENCES Sucursal(IdSucursal),
    FechaElaboracion DATETIME NOT NULL,
    FechaExpiracion DATETIME NULL,
    Descripcion VARCHAR(150) NOT NULL,
    CantidadProducto INT NOT NULL
)


INSERT INTO Inventario VALUES(1,1,'03-01-2022','03-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(2,1,'03-01-2022','03-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(2,2,'18-01-2022','18-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(3,2,'22-01-2022','22-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(4,3,'13-01-2022','13-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(5,3,'19-01-2022',NULL,'CAJA',15)
INSERT INTO Inventario VALUES(6,4,'23-01-2022',NULL,'CAJA',15)
INSERT INTO Inventario VALUES(7,4,'11-01-2022',NULL,'CAJA',15)
INSERT INTO Inventario VALUES(8,5,'04-01-2022',NULL,'CAJA',15)
INSERT INTO Inventario VALUES(9,1,'08-01-2022','08-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(10,1,'16-01-2022','16-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(11,2,'20-06-2022','20-06-2023','CAJA',15)
INSERT INTO Inventario VALUES(12,3,'13-01-2022','13-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(13,4,'05-01-2022','05-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(14,5,'02-01-2022','02-01-2023','CAJA',15)
INSERT INTO Inventario VALUES(14,2,'02-01-2022','02-01-2023','CAJA',6)
INSERT INTO Inventario VALUES(14,5,'02-01-2022','02-01-2023','CAJA',10)
SELECT * FROM Inventario


CREATE TABLE Laboratorio (
    IdLaboratorio INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(50) NOT NULL,
    Direccion VARCHAR (50) NOT NULL,
    Telefono VARCHAR (50) NOT NULL
)

INSERT INTO Laboratorio VALUES ('CON HARINA MEDICAL','BARRIO ABAJO CALLE PRINCIPAL, EDIFICO ROJO','2244-6112')
INSERT INTO Laboratorio VALUES ('LAB MEDICAL','CALLE PRICIPAL, FRENTE A LA TOYOTA','2266-6782')
INSERT INTO Laboratorio VALUES ('MEDICAL','BARRIO EL CASTAÑO, EDIFICO AZUL','2278-6913')
INSERT INTO Laboratorio VALUES ('PRO MEDICAL','BARRIO EL CASTAÑO, EDIFICO AZUL','2222-6999')
INSERT INTO Laboratorio VALUES ('INFARMA','EDIFICIO VERDE, FRENTE AL ESTADIO','2221-5621')
SELECT * FROM Laboratorio

CREATE TABLE Provee (
    IdInventario INT FOREIGN KEY REFERENCES Inventario(IdInventario),
    IdLaboratorio INT FOREIGN KEY REFERENCES Laboratorio(IdLaboratorio)
)


INSERT INTO Provee VALUES(1,1)
INSERT INTO Provee VALUES(12,1)
INSERT INTO Provee VALUES(2,2)
INSERT INTO Provee VALUES(3,3)
INSERT INTO Provee VALUES(13,4)
INSERT INTO Provee VALUES(14,5)
SELECT * FROM Provee


CREATE TABLE Sucursal (
   IdSucursal INT PRIMARY KEY IDENTITY(1,1),
   Departamento VARCHAR(50) NOT NULL,
   Municipio VARCHAR (50) NOT NULL,
   Calle VARCHAR (50) NOT NULL,
   Colonia VARCHAR(50) NOT NULL,
   Telefono VARCHAR (50) NOT NULL

)

INSERT INTO Sucursal VALUES('FRANCISCO MORAZAN','TEGUCIGALPA','PEATONAL','COLONIA DE MENTIRA','2232-1521')
INSERT INTO Sucursal VALUES('FRANCISCO MORAZAN','TEGUCIGALPA','BLV JUAN PABLO','COLONIA DE ALGUN LUGAR','2287-1313')
INSERT INTO Sucursal VALUES('FRANCISCO MORAZAN','TEGUCIGALPA','BLV FUERZAS ARMADAS','LAS BRISAS','2324-5555')
INSERT INTO Sucursal VALUES('FRANCISCO MORAZAN','TEGUCIGALPA','BLV CENTRO AMERICA','LA 21 DE FEBRERO','2266-8833')
INSERT INTO Sucursal VALUES('FRANCISCO MORAZAN','TEGUCIGALPA','CALLE 123','COLONIA ESCONDIDA','2265-1522')
SELECT * FROM Sucursal

CREATE TABLE Empleado (
    IdEmpleado INT PRIMARY KEY IDENTITY(1,1),
    Nombre VARCHAR(50) NOT NULL,
    Apellido VARCHAR(50) NOT NULL,
    FechaNacimiento DATETIME NOT NULL,
    TFijo VARCHAR(50) NULL,
    TCelular VARCHAR(50) NULL,
    IdSucursal INT FOREIGN KEY REFERENCES Sucursal(IdSucursal)
)
INSERT INTO Empleado VALUES('JUAN','TAYLOR','30-03-1994',NULL,NULL,1)
INSERT INTO Empleado VALUES('MARIA','FLORES','16-05-1996','3363-2323',NULL,2)
INSERT INTO Empleado VALUES('MARGARITA','MEJIA','14-03-1995','3356-9898',NULL,3)
INSERT INTO Empleado VALUES('SANDY','FUNEZ','18-02-1997','9727-1419','2214-1722',4)
INSERT INTO Empleado VALUES('CARLOS','MONCADA','30-06-1996','9964-1562',NULL,5)
SELECT * FROM Empleado



CREATE TABLE Atiende (
    Usuario VARCHAR(40) FOREIGN KEY REFERENCES Cliente(Usuario),
    IdEmpleado INT FOREIGN KEY REFERENCES Empleado(IdEmpleado)
)

INSERT INTO Atiende VALUES('GER81FUNEZ',1)
INSERT INTO Atiende VALUES('KER77ROBLES',1)
INSERT INTO Atiende VALUES('KER77ROBLES',2)
INSERT INTO Atiende VALUES('MORDO14',3)
INSERT INTO Atiende VALUES('MORDO14',4)
INSERT INTO Atiende VALUES('MORDO14',5)
INSERT INTO Atiende VALUES('MORDO14',2)
INSERT INTO Atiende VALUES('PEDRO98',2)
INSERT INTO Atiende VALUES('PEDRO98',3)
INSERT INTO Atiende VALUES('PEDRO98',1)


DROP TABLE ATIENDE
SELECT * FROM Compra


/*REPORTES*/

/*1. Edad promedio de los clientes*/
SELECT AVG(DATEDIFF(YEAR,FechaNacimiento,GETDATE())) AS EDAD_PROMEDIO
from Cliente

SELECT * FROM Cliente
/*2. 10 productos más vendidos*/

SELECT TOP 10 NombreP AS TOP_VENTAS, Dc.IdProducto, DC.IdCompra
FROM Producto AS Pr 
INNER JOIN DetalleCompra AS Dc 
ON Pr.IdProducto = Dc.IdProducto


/*3. Cantidad de productos por categoría*/
SELECT Tipo, COUNT(*) AS Categoria
FROM Producto as PR 
INNER JOIN Categoria AS CA 
ON PR.IdCategoria = CA.IdCategoria
GROUP BY Tipo

/*4. Listar los productos mas bajos en ventas*/
SELECT Pr.NombreP, Dc.IdCompra, Pr.Provedor, Co.Usuario FROM Producto AS Pr
INNER JOIN DetalleCompra AS Dc
ON Pr.IdProducto = Dc.IdProducto
INNER JOIN Compra AS Co
ON Dc.IdCompra = Co.IdCompra
WHERE Dc.IdProducto BETWEEN 0 AND 1

/*5. Listado de productos agrupados por categoría*/
 SELECT  Ca.Tipo AS Categoria ,Pr.NombreP  AS Producto
    from Producto AS Pr 
    INNER JOIN Categoria AS Ca
    ON Pr.IdCategoria = Ca.IdCategoria
    ORDER BY Ca.IdCategoria


/*VISTAS*/

/*1. Reporte mensual de ventas por sucursal*/
CREATE VIEW Reporte_Mensual AS
   SELECT  TOP 100 MONTH(Co.FechaCompra) AS Mes,S.IdSucursal,S.Colonia,E.Nombre AS Empleado, Co.IdCompra,Cl.Usuario,Cl.Nombre,Cl.Apellido, P.NombreP FROM Sucursal AS S
        INNER JOIN Compra AS Co 
        ON S.IdSucursal = Co.IdSucursal
        INNER JOIN Cliente AS Cl 
        ON Co.Usuario = Cl.Usuario
        INNER JOIN DetalleCompra AS Dc
        ON Co.IdCompra = Dc.IdCompra
        INNER JOIN Producto AS P
        ON Dc.IdProducto = P.IdProducto
        INNER JOIN Empleado AS E 
        ON E.IdEmpleado = S.IdSucursal
   ORDER BY MONTH(Co.FechaCompra), S.IdSucursal ASC
   



SELECT * FROM Reporte_Mensual 
DROP VIEW Reporte_Mensual


/*2. Reporte de ventas mensual por producto*/
CREATE VIEW Ventas_Producto AS
    SELECT  TOP 100 MONTH(Co.FechaCompra) AS MES,P.IdProducto, P.NombreP AS PRODUCTO,Co.IdCompra, Cl.Usuario FROM Compra AS Co 
        INNER JOIN DetalleCompra AS DC
        ON Co.IdCompra = DC.IdCompra
        INNER JOIN Producto AS P 
        ON P.IdProducto = DC.IdProducto
        INNER JOIN Cliente AS CL 
        ON Co.Usuario = Cl.Usuario
    ORDER BY MONTH(Co.FechaCompra), Co.IdCompra ASC


SELECT * FROM Ventas_Producto

/*3. Total ventas por categoría*/
CREATE VIEW Ventas_Categoria AS
    SELECT   COUNT(DC.IdProducto) AS Medicamento FROM DetalleCompra AS DC 
    INNER JOIN Producto AS P 
    ON P.IdProducto = DC.IdProducto
    INNER JOIN CATEGORIA AS CA 
    ON CA.IdCategoria = P.IdCategoria
    WHERE CA.Tipo = 'MEDICAMENTO'


 /*4. Productos en el inventario con cantidad menor que 10 unidades por sucursal*/
CREATE VIEW Inventarios_Bajos AS
    SELECT I.IdSucursal, I.CantidadProducto FROM SUCURSAL  AS S
    INNER JOIN Inventario AS I
    ON S.IdSucursal = I.IdSucursal
    WHERE I.CantidadProducto BETWEEN 0 AND 10

SELECT * FROM Inventarios_Bajos

/*5. Listado de clientes que no han realizado ningún pedido durante el mes*/
CREATE VIEW Clientes_sin_Pedidos AS
    SELECT * FROM Compra 
    WHERE MONTH(FechaCompra) < 4 /*MES ACTUAL*/

SELECT * FROM Clientes_sin_Pedidos


/*Procedimientos almacenados*/
/*1. Función para búsqueda de clientes por nombre*/

CREATE PROCEDURE getClientes
   (@NOMBRE VARCHAR(50), @APELLIDO VARCHAR(50))
AS
   SELECT * FROM Cliente AS CL
   WHERE CL.Nombre = @NOMBRE AND CL.Apellido= @APELLIDO


EXECUTE getClientes @NOMBRE = 'GERSON', @APELLIDO = 'FUNEZ'


/*2. Eliminar clientes por id*/

CREATE PROCEDURE DELClientes
   (@USUARIO VARCHAR(50))
AS
   DELETE FROM Cliente
   WHERE Usuario = @USUARIO
   PRINT('REGISTRO DE USUARIO ELIMINADO!')


SELECT * FROM Cliente
EXECUTE DELClientes @USUARIO = 'ALE'

    

/*3. Actualizar clientes por id*/
CREATE PROCEDURE UPDATE_Clientes
   (@USUARIO VARCHAR(50),
    @CONTRASEÑA VARCHAR(50),
    @NOMBRE VARCHAR(50),
    @APELLIDO VARCHAR(50),
    @FECHAN DATETIME
    )
AS
    UPDATE Cliente
    SET Contraseña = @CONTRASEÑA, Nombre = @NOMBRE,Apellido= @APELLIDO, FechaNacimiento= @FECHAN
    WHERE Usuario=@USUARIO;

SELECT * FROM Cliente
EXECUTE UPDATE_Clientes @USUARIO = 'GER81FUNEZ', @CONTRASEÑA='987654321',@NOMBRE= 'GERSON MISAEL',
@APELLIDO='FUNEZ MARADIAGA', @FECHAN='31-03-1997'

/*4. Listado de todos los pedidos realizados por un cliente*/
CREATE PROCEDURE GET_PEDIDOS
    (@USUARIO VARCHAR(40))
    AS
    SELECT * FROM Compra
    WHERE Usuario=@USUARIO

SELECT * FROM Compra
EXECUTE GET_PEDIDOS @USUARIO='GER81FUNEZ' 

/*5. Total de ventas de un producto en una fecha determinada*/
CREATE PROCEDURE PRODUCTOS_VENDIDOS
    (@FECHA DATETIME)
    AS
    SELECT * FROM Producto AS P
    INNER JOIN DetalleCompra AS DC 
    ON P.IdProducto = DC.IdProducto
    INNER JOIN Compra AS CO 
    ON DC.IdCompra = CO.IdCompra
    WHERE CO.FechaCompra = @FECHA


SELECT * FROM COMPRA
EXECUTE PRODUCTOS_VENDIDOS @FECHA= '10-03-2022'

